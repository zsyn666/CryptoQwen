<!DOCTYPE html>
<html>
<head>
    <title>æ™ºæ…§ä¼šè®¡åŠ©æ‰‹ - XXèµ„æœ¬é›†å›¢</title>
    <style>
        /* ===== æ ¸å¿ƒå˜é‡ä¸é‡ç½® ===== */
        :root {
            --primary-dark: #0f172a;
            --primary-blue: #1e3a8a;
            --accent-cyan: #06b6d4;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --bg-main: #0f172a;
            --bg-chat: #1e293b;
            --bg-user-msg: linear-gradient(135deg, var(--accent-cyan), #0891b2);
            --bg-assistant-msg: #334155;
            --border-color: #334155;
            --shadow: 0 4px 12px rgba(0,0,0,0.2);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Ensure root and body have explicit height for flex children to compute correctly */
        html, body {
            height: 100%;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, 'Microsoft YaHei', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* ===== å¯åŠ¨åŠ¨ç”» ===== */
        .splash-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-blue));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }
        
        .splash-logo {
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
            margin-bottom: 1.5rem;
            animation: pulse 2s ease-in-out infinite;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .splash-text {
            font-size: 1.5rem;
            color: white;
            font-weight: 300;
            letter-spacing: 3px;
            animation: fadeIn 1s ease-in 0.5s both;
        }
        
        .splash-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 0.5rem;
            animation: fadeIn 1s ease-in 1s both;
        }
        
        .splash-loader {
            width: 36px;
            height: 36px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-top: 1.5rem;
        }
        
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ===== ä¸»å®¹å™¨ ===== */
        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.5s ease-in;
            /* allow correct flex shrinking inside body */
            min-height: 0;
        }
        
        .app-container.loaded {
            opacity: 1;
        }

        /* ===== é¡¶éƒ¨é…ç½®æ  ===== */
        .top-bar {
            background: var(--bg-chat);
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .api-config {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }
        
        .api-config label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        
        .api-config input {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.85rem;
            min-width: 200px;
            transition: var(--transition);
        }
        
        .api-config input:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2);
        }
        
        .api-config button {
            background: linear-gradient(135deg, var(--accent-cyan), #0891b2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: var(--transition);
            white-space: nowrap;
        }
        
        .api-config button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(6, 182, 212, 0.3);
        }
        
        .config-status {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-left: auto;
        }

        /* ===== èŠå¤©åŒºåŸŸ ===== */
        .chat-area {
            flex: 1;
            padding: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            /* é˜²æ­¢æ¨ªå‘æº¢å‡º */
            overflow-x: hidden;
            /* å…è®¸å­å…ƒç´ æ­£ç¡®æ”¶ç¼©ï¼Œé¿å…åœ¨ flex å®¹å™¨ä¸­æº¢å‡º */
            min-height: 0;
        }
        #chat-container {
            flex: 1;
            overflow-y: auto;
            max-width: 100%;
            margin: 0 auto;
            padding-bottom: 120px;
            -webkit-overflow-scrolling: touch;
            min-height: 0;
            max-height: calc(100vh - 160px);
        }

        /* ===== æ¶ˆæ¯æ ·å¼ ===== */
        .message-container {
            margin-bottom: 1.5rem;
            display: flex;
            animation: messageFadeIn 0.3s ease-out;
        }
        
        @keyframes messageFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
            font-size: 0.8rem;
        }
        
        .user-avatar {
            background: var(--bg-user-msg);
            color: white;
            margin-left: 0.75rem;
            box-shadow: 0 2px 6px rgba(6, 182, 212, 0.3);
        }
        
        .assistant-avatar {
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
            margin-right: 0.75rem;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
        }
        
        .message-wrapper {
            max-width: 85%;
            flex: 1;
        }
        
        .user-message-container {
            justify-content: flex-end;
        }
        
        .user-message {
            background: var(--bg-user-msg);
            color: white;
            padding: 0.875rem 1rem;
            border-radius: 16px 16px 4px 16px;
            white-space: pre-wrap;
            word-wrap: break-word;
            box-shadow: var(--shadow);
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .assistant-message {
            background: var(--bg-assistant-msg);
            padding: 0.875rem 1rem;
            border-radius: 16px 16px 16px 4px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* ===== åº•éƒ¨ç»„åˆè¾“å…¥åŒº ===== */
        .bottom-input-area {
            background: var(--bg-chat);
            border-top: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            position: sticky;
            bottom: 0;
        }
        
        .input-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* æ–‡ä»¶ä¸Šä¼ éƒ¨åˆ† */
        .file-upload-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        #file-input {
            display: none;
        }
        
        #file-label {
            background: var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: var(--transition);
            white-space: nowrap;
        }
        
        #file-label:hover {
            background: var(--accent-cyan);
            transform: translateY(-1px);
        }
        
        #file-name {
            font-size: 0.8rem;
            color: var(--text-secondary);
            flex: 1;
        }
        
        .clear-btn {
            background: var(--accent-red);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: var(--transition);
            white-space: nowrap;
        }
        
        .clear-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(239, 68, 68, 0.3);
        }
        
        /* æ¶ˆæ¯è¾“å…¥éƒ¨åˆ† */
        .message-input-section {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }
        
        #file-question-input {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: var(--transition);
            min-height: 44px;
            max-height: 120px;
            resize: vertical;
        }
        
        #file-question-input:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2);
        }
        
        #file-question-input::placeholder {
            color: var(--text-secondary);
        }
        
        #user-input {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: var(--transition);
            min-height: 44px;
            max-height: 120px;
            resize: vertical;
        }
        
        #user-input:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2);
        }
        
        #user-input::placeholder {
            color: var(--text-secondary);
        }
        
        .input-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        #file-send-btn {
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
            border: none;
            padding: 0 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: var(--transition);
            white-space: nowrap;
            height: 44px;
        }
        
        #file-send-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }
        
        #file-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #submit-btn {
            background: linear-gradient(135deg, var(--accent-cyan), #0891b2);
            color: white;
            border: none;
            padding: 0 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: var(--transition);
            white-space: nowrap;
            height: 44px;
        }
        
        #submit-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(6, 182, 212, 0.3);
        }
        
        #submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #file-info {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }

        /* ===== é”™è¯¯ä¿¡æ¯ ===== */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            padding: 0.75rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            font-size: 0.85rem;
        }

        /* ===== æµå¼æŒ‡ç¤ºå™¨ ===== */
        .stream-indicator {
            display: none;
            font-size: 0.8rem;
            color: var(--accent-cyan);
            margin-top: 0.25rem;
            padding: 0.25rem 0.75rem;
            background: rgba(6, 182, 212, 0.1);
            border-radius: 12px;
            border: 1px solid var(--accent-cyan);
        }

        /* ===== æ»šåŠ¨æ¡ ===== */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-main); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-cyan); }

        /* ===== å“åº”å¼ ===== */
        @media (max-width: 768px) {
            .api-config { flex-wrap: wrap; }
            .api-config input { min-width: 150px; width: calc(50% - 0.5rem); }
            .file-upload-section { flex-wrap: wrap; }
            .message-input-section { flex-wrap: wrap; }
            #user-input, #file-question-input { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- å¯åŠ¨åŠ¨ç”» -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-logo">AI</div>
        <div class="splash-text">æ™ºæ…§ä¼šè®¡åŠ©æ‰‹</div>
        <div class="splash-subtitle">XXèµ„æœ¬é›†å›¢ Â· è´¢åŠ¡æ™ºèƒ½å¤„ç†ç³»ç»Ÿ</div>
        <div class="splash-loader"></div>
    </div>

    <!-- ä¸»åº”ç”¨ -->
    <div class="app-container" id="appContainer">
        <!-- é¡¶éƒ¨é…ç½®æ  -->
        <div class="top-bar">
            <div class="api-config">
                <label for="api-url">APIåœ°å€:</label>
                <input type="text" id="api-url" placeholder="http://192.168.1.102:5001">
                <label for="api-key">å¯†é’¥:</label>
                <input type="password" id="api-key" placeholder="è¾“å…¥æ‚¨çš„å¯†é’¥">
                <button id="save-api-btn">ä¿å­˜å¹¶æµ‹è¯•</button>
            </div>
            <div class="config-status">
                å½“å‰é…ç½®: <span id="current-config">æœªé…ç½®</span>
                <div class="api-status" style="display: inline-flex; margin-left: 1rem;">
                    <span id="api-status-indicator" class="avatar status-indicator status-disconnected"></span>
                    <span id="api-status-text" style="margin-left: 0.25rem;">æœªè¿æ¥</span>
                </div>
            </div>
        </div>

        <!-- èŠå¤©åŒºåŸŸ -->
        <div class="chat-area">
            <div id="chat-container"></div>
        </div>

        <!-- åº•éƒ¨ç»„åˆè¾“å…¥åŒº -->
        <div class="bottom-input-area">
            <div class="input-container">
                <!-- æ–‡ä»¶ä¸Šä¼ éƒ¨åˆ† -->
                <div class="file-upload-section">
                    <input type="file" id="file-input" accept=".txt">
                    <label for="file-input" id="file-label">ğŸ“ é€‰æ‹©TXTæ–‡ä»¶</label>
                        <span id="file-name">æœªé€‰æ‹©æ–‡ä»¶</span>
                        <button id="clear-file-btn" title="ç§»é™¤æ–‡ä»¶" style="background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:1rem;">âœ–</button>
                        <button id="clear-btn" class="clear-btn">ğŸ—‘ï¸ æ¸…é™¤å¯¹è¯</button>
                </div>
                
                <!-- æ¶ˆæ¯è¾“å…¥éƒ¨åˆ† -->
                <div class="message-input-section">
                    <textarea id="user-input" placeholder="è¾“å…¥è´¢åŠ¡é—®é¢˜ï¼Œæˆ–é€‰æ‹©æ–‡ä»¶ååœ¨ä¸‹æ–¹è¾“å…¥ç›¸å…³é—®é¢˜..."></textarea>
                    <div class="input-actions">
                        <button id="file-send-btn" disabled>å‘é€æ–‡ä»¶+é—®é¢˜</button>
                        <button id="submit-btn">å‘é€æ¶ˆæ¯</button>
                    </div>
                </div>
                
                <div id="file-info" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // ===== å¯åŠ¨åŠ¨ç”» =====
        window.addEventListener('load', () => {
            setTimeout(() => {
                const splash = document.getElementById('splashScreen');
                const app = document.getElementById('appContainer');
                
                splash.style.opacity = '0';
                setTimeout(() => {
                    splash.style.display = 'none';
                    app.classList.add('loaded');
                }, 500);
            }, 1500);
        });

        // ===== å…¨å±€å˜é‡ =====
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const submitBtn = document.getElementById('submit-btn');
        const clearBtn = document.getElementById('clear-btn');
        const apiStatusIndicator = document.getElementById('api-status-indicator');
        const apiStatusText = document.getElementById('api-status-text');
        const apiUrlInput = document.getElementById('api-url');
        const apiKeyInput = document.getElementById('api-key');
        const saveApiBtn = document.getElementById('save-api-btn');
        const currentConfigSpan = document.getElementById('current-config');
        
        // æ–‡ä»¶ä¸Šä¼ ç›¸å…³
        const fileInput = document.getElementById('file-input');
        const fileNameSpan = document.getElementById('file-name');
        const fileSendBtn = document.getElementById('file-send-btn');
        const fileInfoDiv = document.getElementById('file-info');
        
        let selectedFileContent = '';
        let API_BASE_URL = '';
        let API_KEY = '';
        let isGenerating = false;
        let currentAssistantMessageEl = null;
        let streamIndicator = null;
        let streamAbortController = null;

        // ===== åŠ å¯†/è§£å¯†å‡½æ•° =====
        const encoder = new TextEncoder();
        const textDecoder = new TextDecoder();
        
        function xorCipherBytes(textBytes, key) {
            const keyBytes = encoder.encode(key);
            const resultBytes = new Uint8Array(textBytes.length);
            for (let i = 0; i < textBytes.length; i++) {
                resultBytes[i] = textBytes[i] ^ keyBytes[i % keyBytes.length];
            }
            return resultBytes;
        }
        
        async function uint8ArrayToBase64(bytes) {
            return new Promise((resolve, reject) => {
                const blob = new Blob([bytes], { type: 'application/octet-binary' });
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = () => reject(reader.error);
                reader.readAsDataURL(blob);
            });
        }
        
        function base64ToUint8Array(base64) {
            const binaryString = atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes;
        }
        
        async function encryptPayload(data, key) {
            if (!key) throw new Error("ç¼ºå°‘åŠ å¯†å¯†é’¥ã€‚");
            const plaintext = JSON.stringify(data);
            const textBytes = encoder.encode(plaintext);
            const encryptedBytes = xorCipherBytes(textBytes, key);
            return await uint8ArrayToBase64(encryptedBytes);
        }
        
        function decryptPayload(encryptedPayload, key) {
            if (!key) throw new Error("ç¼ºå°‘è§£å¯†å¯†é’¥ã€‚");
            const encryptedBytes = base64ToUint8Array(encryptedPayload);
            const decryptedBytes = xorCipherBytes(encryptedBytes, key);
            const decryptedJson = textDecoder.decode(decryptedBytes);
            return JSON.parse(decryptedJson);
        }

        // ===== æ–‡ä»¶ä¸Šä¼ å¤„ç†ï¼ˆå‚è€ƒ éšç§åˆè§„_çº¢.1.html å®ç°ï¼‰ =====
        function resetFileState() {
            fileInput.value = '';
            fileNameSpan.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
            selectedFileContent = '';
            fileSendBtn.disabled = true;
            if (fileInfoDiv) fileInfoDiv.style.display = 'none';
        }

        function loadFile(file) {
            if (!file) {
                resetFileState();
                return;
            }

            // ä¸ éšç§åˆè§„_çº¢.1.html ä¿æŒä¸€è‡´ï¼Œä½¿ç”¨ file.type åˆ¤æ–­ï¼ˆæ³¨æ„ï¼šæŸäº›ç¯å¢ƒ file.type å¯èƒ½ä¸ºç©ºï¼‰
            if (file.type !== 'text/plain') {
                showError('è¯·é€‰æ‹©ä¸€ä¸ª .txt æ–‡ä»¶ã€‚');
                resetFileState();
                return;
            }

            fileNameSpan.textContent = file.name;

            const reader = new FileReader();
            reader.onload = function(e) {
                selectedFileContent = e.target.result;
                fileSendBtn.disabled = false;
                if (fileInfoDiv) {
                    fileInfoDiv.textContent = `å·²åŠ è½½æ–‡ä»¶: ${file.name} (${selectedFileContent.length} å­—ç¬¦)`;
                    fileInfoDiv.style.display = 'block';
                    fileInfoDiv.style.marginTop = '0.5rem';
                }
            };
            reader.onerror = function() {
                showError('è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ã€‚');
                resetFileState();
            };
            reader.readAsText(file, 'UTF-8');
        }

        fileInput.addEventListener('change', function() {
            const file = this.files[0];
            loadFile(file);
        });

        const clearFileBtn = document.getElementById('clear-file-btn');
        if (clearFileBtn) {
            clearFileBtn.addEventListener('click', (e) => {
                e.preventDefault();
                resetFileState();
            });
        }

        // ===== APIé…ç½®ç®¡ç† =====
        function loadApiConfig() {
            const savedUrl = localStorage.getItem('api_base_url');
            const savedKey = localStorage.getItem('api_key');
            if (savedUrl) {
                API_BASE_URL = savedUrl;
                apiUrlInput.value = savedUrl;
            }
            if (savedKey) {
                API_KEY = savedKey;
                apiKeyInput.value = savedKey;
            }
            if (savedUrl) {
                currentConfigSpan.textContent = `URL: ${API_BASE_URL} | å¯†é’¥: ${savedKey ? 'å·²é…ç½®' : 'æœªé…ç½®'}`;
                return true;
            }
            currentConfigSpan.textContent = 'æœªé…ç½®';
            return false;
        }
        
        function saveApiConfig(url, key) {
            API_BASE_URL = url;
            API_KEY = key;
            localStorage.setItem('api_base_url', url);
            localStorage.setItem('api_key', key);
            currentConfigSpan.textContent = `URL: ${url} | å¯†é’¥: ${key ? 'å·²é…ç½®' : 'æœªé…ç½®'}`;
        }
        
        // é¡µé¢åŠ è½½
        window.addEventListener('load', function() {
            addMessage("æ‚¨å¥½ï¼æˆ‘æ˜¯æ™ºæ…§ä¼šè®¡åŠ©æ‰‹ã€‚è¯·å…ˆé…ç½®APIåœ°å€å’Œå¯†é’¥å†å¼€å§‹å¯¹è¯ã€‚æ‚¨ä¹Ÿå¯ä»¥ä¸Šä¼ TXTæ–‡ä»¶è¿›è¡Œæ™ºèƒ½åˆ†æã€‚", false);
            if (loadApiConfig()) {
                checkBaseApiStatus();
            }
        });
        
        function updateApiStatus(status, message) {
            apiStatusIndicator.className = 'avatar status-indicator';
            if (status === 'connected') {
                apiStatusIndicator.classList.add('status-connected');
                apiStatusText.textContent = message || 'å·²è¿æ¥';
            } else {
                apiStatusIndicator.classList.add('status-disconnected');
                apiStatusText.textContent = message || 'æœªè¿æ¥';
            }
        }
        
        async function checkBaseApiStatus() {
            if (!API_BASE_URL) {
                updateApiStatus('disconnected');
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (response.ok) {
                    updateApiStatus('connected', 'æœåŠ¡å¯ç”¨');
                } else {
                    updateApiStatus('disconnected', 'æœåŠ¡ä¸å¯è¾¾');
                }
            } catch (error) {
                updateApiStatus('disconnected', 'è¿æ¥å¤±è´¥');
            }
        }
        
        async function testApiConnection() {
            const url = apiUrlInput.value.trim();
            const key = apiKeyInput.value.trim();
            if (!url || !key) {
                showError('è¯·è¾“å…¥APIåœ°å€å’ŒAPIå¯†é’¥ã€‚');
                return;
            }
            saveApiConfig(url, key);
            try {
                const response = await fetch(`${url}/secure-health`, {
                    method: 'POST',
                    headers: { 'X-API-Key': key }
                });
                if (response.ok) {
                    addMessage("APIè¿æ¥å’Œå¯†é’¥éªŒè¯æˆåŠŸï¼", false);
                    updateApiStatus('connected', 'å¯†é’¥å·²éªŒè¯');
                } else {
                    const error = await response.json();
                    showError(`æœåŠ¡å™¨è¿æ¥å¤±è´¥: ${error.detail || response.statusText}`);
                    updateApiStatus('disconnected', `å¯†é’¥æ— æ•ˆ: ${response.status}`);
                }
            } catch (error) {
                showError('APIè¿æ¥æµ‹è¯•å¤±è´¥ã€‚è¯·æ£€æŸ¥åœ°å€æˆ–æœåŠ¡çŠ¶æ€ã€‚');
                updateApiStatus('disconnected', 'è¿æ¥å¤±è´¥');
            }
        }

        // ===== æ¶ˆæ¯å¤„ç† =====
        function addMessage(text, isUser = false) {
            const container = document.createElement('div');
            container.className = `message-container ${isUser ? 'user-message-container' : 'assistant-message-container'}`;
            
            const avatar = document.createElement('div');
            avatar.className = `avatar ${isUser ? 'user-avatar' : 'assistant-avatar'}`;
            avatar.textContent = isUser ? 'U' : 'AI';
            
            const wrapper = document.createElement('div');
            wrapper.className = 'message-wrapper';
            
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'user-message' : 'assistant-message';
            const sanitizedText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            messageDiv.innerHTML = sanitizedText;
            
            wrapper.appendChild(messageDiv);
            
            if (isUser) {
                container.appendChild(wrapper);
                container.appendChild(avatar);
            } else {
                container.appendChild(avatar);
                container.appendChild(wrapper);
            }
            
            chatContainer.appendChild(container);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageDiv;
        }
        
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = `é”™è¯¯: ${message}`;
            chatContainer.appendChild(errorDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function createStreamIndicator() {
            streamIndicator = document.createElement('div');
            streamIndicator.className = 'stream-indicator';
            streamIndicator.textContent = 'æ­£åœ¨æ¥æ”¶æµå¼å“åº”...';
            return streamIndicator;
        }
        
        function updateAssistantMessage(newToken) {
            if (currentAssistantMessageEl) {
                const currentText = currentAssistantMessageEl.textContent || "";
                const sanitizedToken = newToken.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                currentAssistantMessageEl.textContent = currentText + sanitizedToken;
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }
        
        function finishStreaming() {
            if (streamIndicator) {
                streamIndicator.style.display = 'none';
                streamIndicator = null;
            }
            currentAssistantMessageEl = null;
            isGenerating = false;
            submitBtn.disabled = false;
            fileSendBtn.disabled = (selectedFileContent === '' || userInput.value.trim() === '');
            userInput.focus();
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        async function processMessage(message) {
            if (!message || isGenerating) return;
            if (!API_BASE_URL || !API_KEY) {
                showError('è¯·å…ˆé…ç½®APIåœ°å€å’Œå¯†é’¥ã€‚');
                return;
            }
            
            isGenerating = true;
            submitBtn.disabled = true;
            fileSendBtn.disabled = true;
            userInput.value = '';
            
            addMessage(message, true);
            currentAssistantMessageEl = addMessage('', false);
            
            const indicator = createStreamIndicator();
            if (currentAssistantMessageEl) {
                currentAssistantMessageEl.parentNode.parentNode.appendChild(indicator);
                indicator.style.display = 'block';
            }
            
            try {
                const requestData = {
                    text: message,
                    max_tokens: 8000,
                    temperature: 0.7,
                    top_p: 0.9,
                    repetition_penalty: 1.1
                };
                const encryptedPayload = await encryptPayload(requestData, API_KEY);
                const body = JSON.stringify({ payload: encryptedPayload });
                
                streamAbortController = new AbortController();
                const signal = streamAbortController.signal;
                
                const response = await fetch(`${API_BASE_URL}/stream`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: body,
                    signal: signal
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMsg = `æœåŠ¡å™¨é”™è¯¯: ${response.status} ${response.statusText}`;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMsg = `æœåŠ¡å™¨é”™è¯¯: ${errorJson.detail || errorMsg}`;
                    } catch (e) {
                        errorMsg = `æœåŠ¡å™¨é”™è¯¯: ${errorText}`;
                    }
                    throw new Error(errorMsg);
                }
                
                if (!response.body) {
                    throw new Error("å“åº”ä¸­æ²¡æœ‰å¯è¯»å–çš„æµã€‚");
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                try {
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) {
                            console.log("æµå¼ä¼ è¾“å®Œæˆã€‚");
                            break;
                        }
                        
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split(/\r?\n/);
                        buffer = lines.pop();
                        
                        for (const line of lines) {
                            if (line.startsWith(' ')) {
                                try {
                                    const jsonString = line.substring(1).trim();
                                    const eventData = JSON.parse(jsonString);
                                    if (eventData.payload) {
                                        const decryptedData = decryptPayload(eventData.payload, API_KEY);
                                        if (decryptedData.token) {
                                            updateAssistantMessage(decryptedData.token);
                                        }
                                    }
                                } catch (parseError) {
                                    console.error("è§£æSSEäº‹ä»¶æ—¶å‡ºé”™:", parseError, "åŸå§‹è¡Œ:", line);
                                }
                            }
                        }
                    }
                } catch (readError) {
                    if (readError.name === 'AbortError') {
                        console.log("æµå¼è¯·æ±‚è¢«ç”¨æˆ·å–æ¶ˆã€‚");
                        if (currentAssistantMessageEl) {
                            currentAssistantMessageEl.textContent += "\n\n[è¯·æ±‚å·²å–æ¶ˆ]";
                        }
                    } else {
                        throw readError;
                    }
                } finally {
                    reader.releaseLock();
                }
                
            } catch (error) {
                console.error('è¯·æ±‚æˆ–æµå¤„ç†é”™è¯¯:', error);
                let errorText = error.message;
                if (error.message.includes("401")) {
                    errorText = "APIå¯†é’¥æ— æ•ˆï¼Œè¯·é‡æ–°é…ç½®ã€‚";
                }
                if (currentAssistantMessageEl) {
                    currentAssistantMessageEl.textContent = `[é”™è¯¯] ${errorText}`;
                    currentAssistantMessageEl.style.color = 'var(--accent-red)';
                } else {
                    showError(errorText);
                }
            } finally {
                finishStreaming();
                streamAbortController = null;
            }
        }
        
        // å°†ä¸Šä¼ çš„ TXT ç›´æ¥ä½œä¸ºä¸Šä¸‹æ–‡ï¼ˆå‚è€ƒ chat_web_xor.html çš„å®ç°ï¼‰
        async function sendMessage() {
            const question = userInput.value.trim();
            if (!question && !selectedFileContent) {
                showError('è¯·è¾“å…¥é—®é¢˜æˆ–ä¸Šä¼ æ–‡ä»¶ã€‚');
                return;
            }

            let baseMessage = question;
            if (selectedFileContent) {
                baseMessage = `è¯·æ ¹æ®ä»¥ä¸‹æ–‡ä»¶å†…å®¹å›ç­”é—®é¢˜ï¼š\n[æ–‡ä»¶å†…å®¹å¼€å§‹]\n${selectedFileContent}\n[æ–‡ä»¶å†…å®¹ç»“æŸ]\né—®é¢˜ï¼š${question}`;
            }

            // å¯é€‰çš„ä¼˜åŒ–æç¤ºï¼Œä¿æŒä¸ chat_web_xor.html ä¸€è‡´
            const optimizedMessage = `${baseMessage}\nè¯·ç”¨ç®€æ´çš„ä¼šè®¡ä¸“ä¸šæœ¯è¯­å›ç­”ï¼Œæ§åˆ¶åœ¨3-5å¥è¯å†…ã€‚\nå›ç­”åªéœ€è¦åŒ…å«ä»¥ä¸‹è¦ç´ ï¼š\n1. æ ¸å¿ƒç»“è®º\n2. æœ€ç»ˆå»ºè®®`;

            await processMessage(optimizedMessage);
            resetFileState();
        }
        
        async function sendCombinedMessage() {
            const message = userInput.value.trim();
            if (!selectedFileContent || !message || isGenerating) return;
            
            const combinedMessage = `è¯·æ ¹æ®ä»¥ä¸‹æ–‡ä»¶å†…å®¹å›ç­”é—®é¢˜ï¼š

[æ–‡ä»¶å†…å®¹å¼€å§‹]
${selectedFileContent}
[æ–‡ä»¶å†…å®¹ç»“æŸ]

é—®é¢˜ï¼š${message}`;
            
            await processMessage(combinedMessage);
            
            // é‡ç½®æ–‡ä»¶çŠ¶æ€
            fileInput.value = '';
            fileNameSpan.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
            fileSendBtn.disabled = true;
            fileInfoDiv.style.display = 'none';
            selectedFileContent = '';
        }
        
        // ===== äº‹ä»¶ç›‘å¬ =====
        clearBtn.addEventListener('click', () => {
            if (!isGenerating) {
                if (streamAbortController) {
                    streamAbortController.abort();
                    streamAbortController = null;
                }
                chatContainer.innerHTML = '';
                addMessage("å¯¹è¯å·²æ¸…é™¤ã€‚æœ‰ä»€ä¹ˆæ–°é—®é¢˜å—ï¼Ÿ", false);
                
                // é‡ç½®æ–‡ä»¶çŠ¶æ€
                fileInput.value = '';
                fileNameSpan.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                fileSendBtn.disabled = true;
                fileInfoDiv.style.display = 'none';
                selectedFileContent = '';
                
                currentAssistantMessageEl = null;
                streamIndicator = null;
            }
        });
        
        saveApiBtn.addEventListener('click', testApiConnection);
        submitBtn.addEventListener('click', sendMessage);
        fileSendBtn.addEventListener('click', sendCombinedMessage);
        
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        userInput.addEventListener('input', () => {
            fileSendBtn.disabled = !(selectedFileContent && userInput.value.trim());
        });
    </script>
</body>
</html>
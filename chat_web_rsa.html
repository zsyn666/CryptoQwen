<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>æ™ºæ…§ä¼šè®¡åŠ©æ‰‹ - å®‰å…¨èŠå¤©ç•Œé¢</title>
    <style>
        /* ===== æ ¸å¿ƒå˜é‡å®šä¹‰ï¼ˆä»…ä¿®æ”¹æ ·å¼ï¼Œä¸æ”¹åŠ¨HTML/JSï¼‰ ===== */
        :root {
            --primary-dark: #0f172a;
            --primary-blue: #1e3a8a;
            --accent-cyan: #06b6d4;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --bg-main: #0f172a;
            --bg-surface: #1e293b;
            --bg-chat: #1e293b;
            --bg-user-msg: linear-gradient(135deg, #06b6d4, #0891b2);
            --bg-assistant-msg: #334155;
            --border-color: #334155;
            --shadow: 0 4px 12px rgba(0,0,0,0.2);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ===== å…¨å±€æ ·å¼é‡ç½® ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, 'Microsoft YaHei', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* ===== å¯åŠ¨åŠ¨ç”»æ ·å¼ï¼ˆä¿®å¤é®æŒ¡é—®é¢˜ï¼‰===== */
        .splash-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-blue));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
            pointer-events: none; /* å…³é”®ä¿®å¤ï¼šä¸é˜»æŒ¡ç‚¹å‡»äº‹ä»¶ */
        }
        
        .splash-logo {
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
            margin-bottom: 1.5rem;
            animation: pulse 2s ease-in-out infinite;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .splash-text {
            font-size: 1.5rem;
            color: white;
            font-weight: 300;
            letter-spacing: 3px;
            animation: fadeIn 1s ease-in 0.5s both;
        }
        
        .splash-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 0.5rem;
            animation: fadeIn 1s ease-in 1s both;
        }
        
        .splash-loader {
            width: 36px;
            height: 36px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-top: 1.5rem;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== ä¸»åº”ç”¨å®¹å™¨ ===== */
        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.5s ease-in;
            min-height: 0; /* å…è®¸flexå­é¡¹æ”¶ç¼© */
        }
        
        .app-container.loaded {
            opacity: 1;
        }

        /* ===== é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ ===== */
        .header-title {
            text-align: center;
            padding: 1.5rem 0 0.75rem;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        h1 {
            color: var(--text-primary);
            font-size: 1.75rem;
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        .subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        /* ===== APIé…ç½®åŒºåŸŸ ===== */
        .api-config {
            background: var(--bg-surface);
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            flex-shrink: 0;
        }

        /* Toggle button for API config */
        #toggle-config-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.35rem 0.6rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: var(--transition);
        }

        #toggle-config-btn:hover {
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(6,182,212,0.12);
        }

        /* Hidden state for api-config with smooth collapse */
        .api-config {
            max-height: 1200px;
            overflow: hidden;
            transition: max-height 0.32s ease, opacity 0.28s ease, padding 0.28s ease;
        }

        .api-config.hidden {
            max-height: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            opacity: 0;
            border-bottom: none;
        }
        
        .config-row {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }
        
        .api-config label {
            font-weight: 500;
            color: var(--text-secondary);
            width: 80px;
            text-align: right;
            padding-top: 0.5rem;
            font-size: 0.85rem;
        }
        
        .api-config input, .api-config textarea {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.85rem;
            transition: var(--transition);
            flex: 1;
            font-family: inherit;
        }
        
        .api-config input:focus, .api-config textarea:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2);
        }
        
        .api-config textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .api-config button {
            background: linear-gradient(135deg, var(--accent-cyan), #0891b2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            margin-left: 88px;
            align-self: flex-start;
        }
        
        .api-config button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(6, 182, 212, 0.3);
        }
        
        .config-status {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-left: 88px;
            line-height: 1.5;
        }

        /* ===== èŠå¤©å®¹å™¨ï¼ˆä¿®å¤æ»šåŠ¨é—®é¢˜ï¼‰===== */
        .chat-wrapper {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto !important; /* å¼ºåˆ¶å¯ç”¨æ»šåŠ¨ */
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            min-height: 0; /* å…è®¸flexå­é¡¹æ”¶ç¼© */
        }
        
        #chat-container {
            max-width: 100%;
            margin: 0 auto;
            padding-bottom: 2rem;
        }

        /* ===== æ¶ˆæ¯æ ·å¼ ===== */
        .message-container {
            display: flex;
            margin-bottom: 1.25rem;
            animation: messageFadeIn 0.3s ease-out;
        }
        
        @keyframes messageFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message-container {
            justify-content: flex-end;
        }
        
        .assistant-message-container {
            justify-content: flex-start;
        }
        
        .message-wrapper {
            max-width: 85%;
            flex: 1;
        }
        
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
            font-size: 0.8rem;
        }
        
        .user-avatar {
            background: var(--bg-user-msg);
            color: white;
            margin-left: 0.75rem;
            box-shadow: 0 2px 6px rgba(6, 182, 212, 0.3);
        }
        
        .assistant-avatar {
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
            margin-right: 0.75rem;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
        }
        
        .user-message {
            background: var(--bg-user-msg);
            color: white;
            padding: 0.875rem 1rem;
            border-radius: 16px 16px 4px 16px;
            box-shadow: var(--shadow);
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .assistant-message {
            background: var(--bg-assistant-msg);
            padding: 0.875rem 1rem;
            border-radius: 16px 16px 16px 4px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .thinking-block {
            background: rgba(6, 182, 212, 0.1);
            border: 1px dashed var(--accent-cyan);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-style: italic;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .thinking-block:before {
            content: "Thinking...";
            font-weight: 600;
            display: block;
            margin-bottom: 0.25rem;
            color: var(--accent-cyan);
        }
        
        .response-block {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .message-timestamp {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* ===== åº•éƒ¨ç»„åˆè¾“å…¥åŒº ===== */
        .bottom-input-area {
            background: var(--bg-surface);
            border-top: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            flex-shrink: 0;
        }
        
        .input-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .file-upload-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        #upload-btn {
            background: var(--border-color);
            color: var(--text-primary);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: var(--transition);
            white-space: nowrap;
        }
        
        #upload-btn:hover:not(:disabled) {
            background: var(--accent-cyan);
            transform: translateY(-1px);
        }
        
        #file-info {
            flex: 1;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        #user-input {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: var(--transition);
            min-height: 44px;
            max-height: 120px;
            resize: vertical;
            outline: none;
        }
        
        #user-input:focus {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2);
        }
        
        #submit-btn {
            background: linear-gradient(135deg, var(--accent-cyan), #0891b2);
            color: white;
            border: none;
            padding: 0 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: var(--transition);
            white-space: nowrap;
            height: 44px;
        }
        
        #submit-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(6, 182, 212, 0.3);
        }

        /* ===== ç³»ç»Ÿä¿¡æ¯ ===== */
        .system-info {
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 0.75rem;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        /* ===== è‡ªå®šä¹‰æ»šåŠ¨æ¡ ===== */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-cyan);
        }

        /* ===== å“åº”å¼è®¾è®¡ ===== */
        @media (max-width: 768px) {
            .config-row {
                flex-wrap: wrap;
            }
            .api-config label {
                width: 100%;
                text-align: left;
                padding-top: 0;
                margin-bottom: 0.25rem;
            }
            .api-config button {
                margin-left: 0;
                width: 100%;
            }
            .config-status {
                margin-left: 0;
            }
            .file-upload-section {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <!-- å¯åŠ¨åŠ¨ç”» -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-logo">AI</div>
        <div class="splash-text">æ™ºæ…§ä¼šè®¡åŠ©æ‰‹</div>
        <div class="splash-subtitle">XXèµ„æœ¬é›†å›¢ Â· è´¢åŠ¡æ™ºèƒ½å¤„ç†ç³»ç»Ÿ</div>
        <div class="splash-loader"></div>
    </div>

    <!-- ä¸»åº”ç”¨å®¹å™¨ -->
    <div class="app-container" id="appContainer">
        <!-- é¡¶éƒ¨æ ‡é¢˜ -->
        <div class="header-title">
            <div style="display:flex;align-items:center;justify-content:center;gap:12px;">
                <h1>æ™ºæ…§ä¼šè®¡åŠ©æ‰‹</h1>
                <button id="toggle-config-btn" title="æ˜¾ç¤º/éšè— API é…ç½®" aria-expanded="true">éšè—é…ç½®</button>
            </div>
            <div class="subtitle">æ™ºæ…§ä¼šè®¡åŠ©æ‰‹ Â· XXèµ„æœ¬é›†å›¢</div>
        </div>

        <!-- APIé…ç½®åŒºåŸŸ -->
        <div class="api-config">
            <div class="config-row">
                <label for="api-url">APIåœ°å€ï¼š</label>
                <input type="text" id="api-url" placeholder="http://localhost:5001">
            </div>
            <div class="config-row">
                <label for="server-public-key">API å¯†é’¥ï¼š</label>
                <textarea id="server-public-key" placeholder="è¯·è¾“å…¥PEMæ ¼å¼å…¬é’¥"></textarea>
            </div>
            <div class="config-row">
                <button id="save-api-btn">ä¿å­˜å¹¶æµ‹è¯•è¿æ¥</button>
            </div>
            <div class="config-status">
                å½“å‰APIåœ°å€ï¼š<span id="current-config-url">æœªé…ç½®</span><br>
                å…¬é’¥çŠ¶æ€ï¼š<span id="current-config-key" style="color: var(--accent-red);">æœªé…ç½®</span>
            </div>
        </div>

        <!-- èŠå¤©åŒºåŸŸ -->
        <div class="chat-wrapper">
            <div id="chat-container"></div>
        </div>

        <!-- åº•éƒ¨ç»„åˆè¾“å…¥åŒº -->
        <div class="bottom-input-area">
            <div class="input-container">
                <div class="file-upload-section">
                    <input type="file" id="file-input" accept=".txt">
                    <button id="upload-btn">ğŸ“ ä¸Šä¼ æ–‡ä»¶</button>
                    <div id="file-info"></div>
                    <button id="clear-btn" class="clear-btn">ğŸ—‘ï¸ æ¸…é™¤å¯¹è¯</button>
                </div>
                
                <div class="message-input-section">
                    <textarea id="user-input" placeholder="è¾“å…¥è´¢åŠ¡é—®é¢˜ï¼Œæˆ–å…ˆä¸Šä¼ æ–‡ä»¶ä½œä¸ºä¸Šä¸‹æ–‡..."></textarea>
                    <button id="submit-btn">å‘é€</button>
                </div>
            </div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€ä¿¡æ¯ -->
        <div class="system-info">
            <div class="api-status">
                <span>APIçŠ¶æ€:</span>
                <span id="api-status-indicator" class="status-indicator status-disconnected"></span>
                <span id="api-status-text">æœªè¿æ¥</span>
            </div>
        </div>
    </div>

    <!-- åŸJavaScriptä»£ç ï¼ˆä¿æŒä¸å˜ï¼‰ -->
    <script>
        // --- START: RSA Hybrid Crypto Helper Functions ---
        const cryptoUtils = {
            encoder: new TextEncoder(),
            decoder: new TextDecoder(),

            pemToArrayBuffer(pem) {
                const b64Lines = pem.replace(/-----(BEGIN|END) PUBLIC KEY-----/g, '').trim();
                const b64 = b64Lines.replace(/\s/g, '');
                const binaryStr = atob(b64);
                const len = binaryStr.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryStr.charCodeAt(i);
                }
                return bytes.buffer;
            },

            async getRsaPublicKey(pem) {
                const buffer = this.pemToArrayBuffer(pem);
                return window.crypto.subtle.importKey(
                    "spki", // SubjectPublicKeyInfo format
                    buffer, {
                        name: "RSA-OAEP",
                        hash: "SHA-256"
                    },
                    false, // Not extractable
                    ["encrypt"]
                );
            },

            async hybridEncrypt(data, serverPublicKeyPem) {
                const symmetricKey = await window.crypto.subtle.generateKey({
                        name: "AES-GCM",
                        length: 256
                    },
                    true, // Make it exportable to encrypt it
                    ["encrypt", "decrypt"]
                );
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const encodedData = this.encoder.encode(JSON.stringify(data));
                const encryptedPayload = await window.crypto.subtle.encrypt({
                    name: "AES-GCM",
                    iv
                }, symmetricKey, encodedData);
                const fullPayloadMessage = new Uint8Array(iv.length + encryptedPayload.byteLength);
                fullPayloadMessage.set(iv);
                fullPayloadMessage.set(new Uint8Array(encryptedPayload), iv.length);

                const rsaPublicKey = await this.getRsaPublicKey(serverPublicKeyPem);
                const exportedSymKeyRaw = await window.crypto.subtle.exportKey("raw", symmetricKey);
                const encryptedSymmetricKey = await window.crypto.subtle.encrypt({
                    name: "RSA-OAEP"
                }, rsaPublicKey, exportedSymKeyRaw);

                return {
                    encrypted_key: this.toBase64(encryptedSymmetricKey),
                    payload: this.toBase64(fullPayloadMessage),
                    symmetricKey: symmetricKey
                };
            },

            async symmetricDecrypt(base64Ciphertext, symmetricKey) {
                const fullMessage = this.fromBase64(base64Ciphertext);
                const iv = fullMessage.slice(0, 12);
                const ciphertext = fullMessage.slice(12);

                const decrypted = await window.crypto.subtle.decrypt({
                    name: "AES-GCM",
                    iv
                }, symmetricKey, ciphertext);

                return JSON.parse(this.decoder.decode(decrypted));
            },

            toBase64(buffer) {
                return btoa(String.fromCharCode.apply(null, new Uint8Array(buffer)));
            },

            fromBase64(base64) {
                const binStr = atob(base64);
                const len = binStr.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binStr.charCodeAt(i);
                }
                return bytes;
            }
        };
        // --- END: Crypto Helper Functions ---

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const submitBtn = document.getElementById('submit-btn');
        const clearBtn = document.getElementById('clear-btn');
        const apiStatusIndicator = document.getElementById('api-status-indicator');
        const apiStatusText = document.getElementById('api-status-text');
        const apiUrlInput = document.getElementById('api-url');
        const serverPublicKeyTextarea = document.getElementById('server-public-key');
        const saveApiBtn = document.getElementById('save-api-btn');
        const currentConfigUrlSpan = document.getElementById('current-config-url');
        const currentConfigKeySpan = document.getElementById('current-config-key');

        // New file input elements
        const uploadBtn = document.getElementById('upload-btn');
        const fileInput = document.getElementById('file-input');
        const fileInfo = document.getElementById('file-info');

        let API_BASE_URL = '';
        let SERVER_PUBLIC_KEY = '';
        let isGenerating = false;
        let uploadedFileContent = '';

        function loadApiConfig() {
            const savedUrl = localStorage.getItem('api_base_url');
            const savedKey = localStorage.getItem('server_public_key');

            if (savedUrl) {
                API_BASE_URL = savedUrl;
                apiUrlInput.value = savedUrl;
                currentConfigUrlSpan.textContent = savedUrl;
            } else {
                currentConfigUrlSpan.textContent = 'æœªé…ç½®';
            }

            if (savedKey) {
                SERVER_PUBLIC_KEY = savedKey;
                serverPublicKeyTextarea.value = savedKey;
                currentConfigKeySpan.textContent = 'å·²é…ç½®';
                currentConfigKeySpan.style.color = 'green';
            } else {
                currentConfigKeySpan.textContent = 'æœªé…ç½®';
                currentConfigKeySpan.style.color = 'red';
            }
            return savedUrl && savedKey;
        }

        function saveApiConfig(url, key) {
            if (url) {
                API_BASE_URL = url;
                localStorage.setItem('api_base_url', url);
                apiUrlInput.value = url;
                currentConfigUrlSpan.textContent = url;
            }
            if (key) {
                SERVER_PUBLIC_KEY = key;
                localStorage.setItem('server_public_key', key);
                serverPublicKeyTextarea.value = key;
                currentConfigKeySpan.textContent = 'å·²é…ç½®';
                currentConfigKeySpan.style.color = 'green';
            }
        }

        window.onload = async function() {
            addMessage("ä½ å¥½ï¼æˆ‘æ˜¯æ™ºæ…§ä¼šè®¡åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿæ‚¨å¯ä»¥ä¸Šä¼ TXTæ–‡ä»¶ä½œä¸ºå¯¹è¯ä¸Šä¸‹æ–‡ã€‚", false);
            const hasConfig = loadApiConfig();
            if (hasConfig) {
                // å°è¯•æ£€æŸ¥ API çŠ¶æ€ï¼Œä½†ä¸é˜»å¡å¯åŠ¨åŠ¨ç”»
                checkApiStatus().catch(() => {});
            }
            const splash = document.getElementById('splashScreen');
            const app = document.getElementById('appContainer');
            setTimeout(() => {
                try {
                    splash.style.opacity = '0';
                    splash.style.pointerEvents = 'none';
                    // ç­‰å¾…è¿‡æ¸¡ç»“æŸåç§»é™¤å…ƒç´ ä»¥é‡Šæ”¾å±‚å ä¸Šä¸‹æ–‡
                    splash.addEventListener('transitionend', () => {
                        if (splash && splash.parentNode) splash.parentNode.removeChild(splash);
                    });
                } catch (e) {
                    // ignore
                }
                app.classList.add('loaded');
            }, 600);
        };

        async function sendMessage() {
            const userMessage = userInput.value.trim();
            if (!userMessage && !uploadedFileContent) {
                showError('è¯·è¾“å…¥æ¶ˆæ¯æˆ–ä¸Šä¼ æ–‡ä»¶ã€‚');
                return;
            }
            if (isGenerating) return;
            if (!API_BASE_URL) {
                showError('è¯·å…ˆé…ç½®å¹¶ä¿å­˜APIåœ°å€');
                return;
            }
            if (!SERVER_PUBLIC_KEY) {
                showError('è¯·å…ˆé…ç½®å¹¶ä¿å­˜æœåŠ¡å™¨å…¬é’¥');
                return;
            }

            const isConnected = await checkApiStatus();
            if (!isConnected) {
                showError('æ— æ³•è¿æ¥åˆ°APIæœåŠ¡ï¼Œè¯·æ£€æŸ¥åœ°å€æˆ–æœåŠ¡æ˜¯å¦å¯åŠ¨');
                return;
            }

            isGenerating = true;
            submitBtn.disabled = true;
            uploadBtn.disabled = true;
            userInput.value = '';

            let fullMessage = userMessage;
            if (uploadedFileContent) {
                const fileContext = `--- ä¸Šä¼ çš„æ–‡ä»¶å†…å®¹ ---\n${uploadedFileContent}\n--- æ–‡ä»¶å†…å®¹ç»“æŸ ---`;
                fullMessage = `${fileContext}\n\n${userMessage}`;
                addMessage(`å·²å°†æ–‡ä»¶ "${fileInfo.textContent.replace('å·²ä¸Šä¼ : ', '').replace(' [ç§»é™¤]', '')}" çš„å†…å®¹ä½œä¸ºä¸Šä¸‹æ–‡å‘é€ã€‚`, false, null,
                    "system");
            }

            addMessage(fullMessage, true);

            // Clear file content after using it
            uploadedFileContent = '';
            fileInfo.innerHTML = '';

            const assistantMessageId = `msg-${Date.now()}`;
            const assistantMessageEl = addMessage('...', false, assistantMessageId);

            // å›ºå®šä½¿ç”¨æµå¼ä¼ è¾“
            const mode = 'stream';

            try {
                const requestBody = {
                    text: fullMessage,
                    max_tokens: 8000,
                    temperature: 0.7
                };
                const {
                    encrypted_key,
                    payload,
                    symmetricKey
                } = await cryptoUtils.hybridEncrypt(requestBody, SERVER_PUBLIC_KEY);
                const finalPayload = {
                    encrypted_key,
                    payload
                };

                if (mode === 'stream') {
                    await handleStreamRequest(finalPayload, symmetricKey, assistantMessageEl);
                } else {
                    await handleNonStreamRequest(finalPayload, symmetricKey, assistantMessageEl);
                }
            } catch (error) {
                console.error('è¯·æ±‚å‡ºé”™:', error);
                const errorMsg = `åŠ å¯†æˆ–è¯·æ±‚å¤±è´¥: ${error.message}. æ£€æŸ¥å…¬é’¥æ ¼å¼å’ŒAPIè¿æ¥.`;
                assistantMessageEl.textContent = errorMsg;
                showError(errorMsg);
            } finally {
                isGenerating = false;
                submitBtn.disabled = false;
                uploadBtn.disabled = false;
                userInput.focus();
            }
        }

        async function handleNonStreamRequest(payload, symmetricKey, messageElement) {
            const response = await fetch(`${API_BASE_URL}/generate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status} ${response.statusText} - ${errorText}`);
            }

            const encryptedResponse = await response.json();
            const data = await cryptoUtils.symmetricDecrypt(encryptedResponse.payload, symmetricKey);
            renderThinkingAndResponse(messageElement, data.generated_text);
        }

        async function handleStreamRequest(payload, symmetricKey, messageElement) {
            const response = await fetch(`${API_BASE_URL}/generate-stream`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'text/event-stream'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status} ${response.statusText}`);
            if (!response.body) throw new Error('æœªæ¥æ”¶åˆ°å“åº”ä½“');

            messageElement.innerHTML = '...';
            const reader = response.body.getReader();
            const decoder = new TextDecoder('utf-8');
            let buffer = '';
            let fullText = '';

            while (true) {
                const {
                    value,
                    done
                } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, {
                    stream: true
                });
                let eventEnd;
                while ((eventEnd = buffer.indexOf('\n\n')) !== -1) {
                    const eventData = buffer.slice(0, eventEnd);
                    buffer = buffer.slice(eventEnd + 2);

                    if (eventData.startsWith('data: ')) {
                        try {
                            const encryptedChunk = JSON.parse(eventData.replace('data: ', ''));
                            if (encryptedChunk.payload) {
                                const chunk = await cryptoUtils.symmetricDecrypt(encryptedChunk.payload, symmetricKey);
                                if (chunk.generated_text) {
                                    fullText += chunk.generated_text;
                                    renderThinkingAndResponse(messageElement, fullText);
                                }
                                if (chunk.error) {
                                    showError(`Stream error: ${chunk.error}`);
                                    return;
                                }
                                if (chunk.is_end) return;
                            }
                        } catch (e) {
                            console.error('è§£ææˆ–è§£å¯†æµæ•°æ®é”™è¯¯:', e);
                        }
                    }
                }
            }
        }

        saveApiBtn.addEventListener('click', async function() {
            const url = apiUrlInput.value.trim();
            const key = serverPublicKeyTextarea.value.trim();
            if (!url) {
                showError('è¯·è¾“å…¥æœ‰æ•ˆçš„APIåœ°å€');
                return;
            }
            if (!key || !key.includes('-----BEGIN PUBLIC KEY-----')) {
                showError('è¯·è¾“å…¥æœ‰æ•ˆçš„PEMæ ¼å¼å…¬é’¥');
                return;
            }
            saveApiConfig(url, key);
            const isConnected = await checkApiStatus();
            if (isConnected) {
                addMessage("APIè¿æ¥æµ‹è¯•æˆåŠŸï¼æœåŠ¡æ­£å¸¸è¿è¡Œã€‚", false);
            } else {
                showError('APIè¿æ¥æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥åœ°å€æˆ–æœåŠ¡çŠ¶æ€');
            }
        });

        uploadBtn.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type !== 'text/plain') {
                showError('è¯·åªä¸Šä¼  .txt æ ¼å¼çš„æ–‡ä»¶ã€‚');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedFileContent = e.target.result;
                fileInfo.innerHTML = `å·²ä¸Šä¼ : ${file.name} <span id="remove-file" title="ç§»é™¤æ–‡ä»¶"> [ç§»é™¤]</span>`;
                document.getElementById('remove-file').addEventListener('click', () => {
                    uploadedFileContent = '';
                    fileInfo.innerHTML = '';
                    fileInput.value = '';
                });
            };
            reader.onerror = () => {
                showError('è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ã€‚');
                uploadedFileContent = '';
            };
            reader.readAsText(file);
        });

        function addMessage(text, isUser = false, messageId = null, type = "normal") {
            if (type === "system") {
                const systemMsg = document.createElement('div');
                systemMsg.style.textAlign = 'center';
                systemMsg.style.fontSize = '0.8em';
                systemMsg.style.color = 'var(--text-secondary)';
                systemMsg.style.margin = '10px 0';
                systemMsg.textContent = text;
                chatContainer.appendChild(systemMsg);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                return systemMsg;
            }
            const container = document.createElement('div');
            container.className = `message-container ${isUser ? 'user-message-container' : 'assistant-message-container'}`;
            const avatar = document.createElement('div');
            avatar.className = `avatar ${isUser ? 'user-avatar' : 'assistant-avatar'}`;
            avatar.textContent = isUser ? 'U' : 'AI';
            const wrapper = document.createElement('div');
            wrapper.className = 'message-wrapper';
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'user-message' : 'assistant-message';
            if (messageId) messageDiv.id = messageId;
            messageDiv.textContent = text;
            wrapper.appendChild(messageDiv);
            const timestamp = document.createElement('div');
            timestamp.className = 'message-timestamp';
            const now = new Date();
            timestamp.textContent = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            wrapper.appendChild(timestamp);
            if (isUser) {
                container.appendChild(wrapper);
                container.appendChild(avatar);
            } else {
                container.appendChild(avatar);
                container.appendChild(wrapper);
            }
            chatContainer.appendChild(container);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageDiv;
        }

        function updateApiStatus(status) {
            apiStatusIndicator.classList.remove('status-connected', 'status-disconnected');
            if (status === 'connected') {
                apiStatusIndicator.classList.add('status-connected');
                apiStatusText.textContent = 'å·²è¿æ¥';
            } else {
                apiStatusIndicator.classList.add('status-disconnected');
                apiStatusText.textContent = 'æœªè¿æ¥';
            }
        }

        async function checkApiStatus() {
            if (!API_BASE_URL) {
                updateApiStatus('disconnected');
                return false;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (response.ok && (await response.json()).status === 'healthy') {
                    updateApiStatus('connected');
                    return true;
                }
                updateApiStatus('disconnected');
                return false;
            } catch (error) {
                updateApiStatus('disconnected');
                return false;
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = `é”™è¯¯: ${message}`;
            chatContainer.appendChild(errorDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function renderThinkingAndResponse(element, fullText) {
            const thinkRegex = /<think>(.*?)<\/think>/s;
            const thinkMatch = fullText.match(thinkRegex);
            let thinkingContent = '';
            let responseContent = fullText;
            if (thinkMatch) {
                thinkingContent = thinkMatch[1].trim();
                responseContent = fullText.replace(thinkRegex, '').trim();
            }
            let html = '';
            if (thinkingContent) {
                const sanitizedThinking = thinkingContent.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                html += `<div class="thinking-block">${sanitizedThinking}</div>`;
            }
            if (responseContent || thinkingContent) {
                const sanitizedResponse = responseContent.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                html += `<div class="response-block">${sanitizedResponse || '...'}</div>`;
            } else {
                html = '...';
            }
            element.innerHTML = html;
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        clearBtn.addEventListener('click', function() {
            if (!isGenerating) {
                chatContainer.innerHTML = '';
                uploadedFileContent = '';
                fileInfo.innerHTML = '';
                fileInput.value = '';
                addMessage("å¯¹è¯å·²æ¸…é™¤ã€‚æœ‰ä»€ä¹ˆæ–°é—®é¢˜å—ï¼Ÿ", false);
            }
        });

        submitBtn.addEventListener('click', sendMessage);
        
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆåèšç„¦è¾“å…¥æ¡†
        userInput.focus();

        // ===== æ·»åŠ  API é…ç½® æ˜¾ç¤º/éšè— åˆ‡æ¢å’ŒæŒä¹…åŒ– =====
        (function() {
            const apiConfigEl = document.querySelector('.api-config');
            const toggleBtn = document.getElementById('toggle-config-btn');
            if (!apiConfigEl || !toggleBtn) return;

            function setApiConfigHidden(hidden, save = true) {
                if (hidden) {
                    apiConfigEl.classList.add('hidden');
                    toggleBtn.textContent = 'æ˜¾ç¤ºé…ç½®';
                    toggleBtn.setAttribute('aria-expanded', 'false');
                } else {
                    apiConfigEl.classList.remove('hidden');
                    toggleBtn.textContent = 'éšè—é…ç½®';
                    toggleBtn.setAttribute('aria-expanded', 'true');
                }
                if (save) localStorage.setItem('api_config_hidden', hidden ? '1' : '0');
            }

            toggleBtn.addEventListener('click', () => {
                const isHidden = apiConfigEl.classList.contains('hidden');
                setApiConfigHidden(!isHidden);
            });

            // Initialize from saved preference
            try {
                const saved = localStorage.getItem('api_config_hidden');
                if (saved === '1') setApiConfigHidden(true, false);
            } catch (e) {
                // ignore localStorage errors
            }
        })();
    </script>
</body>
</html>